/*!
betajs-dexie - v0.0.7 - 2020-06-21
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Databases.Dexie"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"5bd48095-7aea-4962-b1d3-75a575bce453",version:"0.0.7",datetime:1592783126222}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:DexieDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Iterators.ArrayIterator","base:Tokens","base:Objs","base:Types","data:Queries"],function(e,o,u,i,c,d,_,t){var n=["weak"];return e.extend({scoped:t},function(t){return{table:function(){return this.__table||(this.__table=this._database._getTable(this._table_name)),this.__table},primary_key:function(){return"_id"},_insertRow:function(t){return t[this.primary_key()]||(t[this.primary_key()]=i.generate_token()),o.fromNativePromise(this.table().add(t)).mapSuccess(function(e){return t},this)},_removeRow:function(e){return o.fromNativePromise(this.table()["delete"](e[this.primary_key()]))},_findOne:function(e){return e[this.primary_key()]?o.fromNativePromise(this.table().get(e[this.primary_key()])):t._findOne.call(this,e)},_updateRow:function(e,t){return o.fromNativePromise(this.table().update(e[this.primary_key()],t)).mapSuccess(function(){return t})},_encode:function(t){return t=c.map(t,function(e){return e&&(d.is_object(e)||d.is_array(e))?this._encode(e):e},this),n.forEach(function(e){e in t&&(t[e+"_reserved"]=t[e],delete t[e])}),t},_decode:function(t){return t=c.map(t,function(e){return e&&(d.is_object(e)||d.is_array(e))?this._decode(e):e},this),n.forEach(function(e){e+"_reserved"in t&&(t[e]=t[e+"_reserved"],delete t[e+"_reserved"])}),t},_clear:function(){return o.fromNativePromise(this.table().clear())},_find:function(t,i){var n=t;if(!(t=t||{})||d.is_empty(t))return o.fromNativePromise(this.table().toArray()).mapSuccess(function(e){return new u(e)},this);var e=c.splitObject(t,function(e){return _.is_simple_atom(e)});console.log(e);var r=this.table(),a=!1;d.is_empty(e[0])||(r=r.where(e[0]),a=!0),t=e[1],!d.is_empty(t)&&a&&(r=r.and(function(e){return _.evaluate(t,e)})),(i=i||{}).skip&&(r=r.offset(i.skip)),i.limit&&(r=r.limit(i.limit));var s=i.sort?r.sortBy(c.ithKey(i.sort)):r.toArray();return o.fromNativePromise(s).mapSuccess(function(e){return d.is_empty(t)||a||(e=e.filter(function(e){return _.evaluate(t,e)})),new u(e)},this).error(function(e){console.warn(e,n,i)})}}})}),e.define("module:DexieDatabase",["data:Databases.Database","base:Promise","module:DexieDatabaseTable","base:Objs","base:Types"],function(e,t,n,r,a,i){return e.extend({scoped:i},function(i){return{constructor:function(e,t){i.constructor.call(this),this._db=e,this._config=t||{},this._dexie=null},destroy:function(){this._unbind(),i.destroy.call(this)},_unbind:function(){this._dexie&&(this._dexie.close(),this._dexie=null)},_bind:function(){this._dexie||(this._dexie=new Dexie(this._db),this._dexie.version(1).stores(r.map(this._config,function(e){return a.is_array(e)?e.join(","):e})),this._dexie.open())},_tableClass:function(){return n},_getTable:function(e){return this._bind(),this._dexie[e]},deleteDatabase:function(){return this._unbind(),Dexie["delete"](this._db)}}})})}).call(Scoped);